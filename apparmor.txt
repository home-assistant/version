#include <tunables/global>

profile hassio-supervisor flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/python>

  network,
  deny network raw,

  signal (send) set=(kill,term,int),

  capability net_bind_service,
  capability dac_read_search,
  capability dac_override,

  /bin/busybox ix,
  /bin/udevadm Ux,
  /sbin/udevd Ux,
  /usr/local/bin/python{,3,3.[0-9]} ix,
  /usr/bin/git cx,
  /usr/bin/socat cx,
  /usr/bin/gdbus cx,

  deny /proc/** wl,
  deny /root/** wl,
  deny /sys/** wl,

  / r,
  /** r,
  /tmp/** rw,
  /data/** rw,
  /dev/tty rw,
  /{,var/}run/docker.sock rw,
  /etc/resolv.conf rw,

  /usr/local/lib/python3.[0-9]/** mr,
  /usr/local/lib/libpython* mr,

  profile /usr/bin/socat flags=(attach_disconnected,mediate_deleted) {
    #include <abstractions/base>

    network inet udp,
    network inet tcp,

    deny network raw,
    deny network packet,

    signal (receive) set=(kill,term),
    capability net_bind_service,

    /lib/* mr,
    /usr/bin/socat mr,
  }

  profile /usr/bin/gdbus flags=(attach_disconnected,mediate_deleted) {
    #include <abstractions/base>
    #include <abstractions/dbus>

    signal (receive) set=(int),
    unix (send, receive) type=stream,

    /usr/bin/gdbus mr,
    /lib/* mr,
    /** r,

    /{,var/}run/dbus/system_bus_socket rw,
  }

  profile /usr/bin/git flags=(attach_disconnected,mediate_deleted) {
    #include <abstractions/base>

    network,
    deny network raw,

    signal (receive) set=(term),

    /bin/busybox ix,
    /usr/bin/git mr,
    /usr/libexec/git-core/* ix,

    deny /data/homeassistant rw,
    deny /data/ssl rw,

    /** r,
    /lib/* mr,
    /data/addons/** lrw,

    capability dac_override,
  }
}
